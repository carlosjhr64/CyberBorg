#!/usr/bin/env ruby
# Was having problems with -w option in coffee...

# Currently, there are no options, but let's stip them out.
options = ''
while ARGV[0]=~/^-/ do
  options += ARGV.shift
end

# The *.js file to write.
target = ARGV.shift
raise "Need target *.js file" unless target and target =~ /\.js$/

# The *.coffee files to read in.
files = []
while file = ARGV.shift do
  raise "Input files need to be *.coffee" unless file =~ /\.coffee$/
  if File.exist?(file)
    files.push(file)
  else
    raise "#{file} not found"
  end
end
raise "need input files" unless files.length > 0

# The coffee command to run
command = "coffee -j #{target} -cbl #{files.join(' ')}"

# Do an initial compile
if system(command)
  system("ls -tl #{target}")
  # Get the compile time
  mtime = File.mtime(target)
  while true do
    # Check every second
    sleep 1
    files.each do |file|
      # See if a file was edited
      if File.mtime(file) > mtime
        # Compile and show result
        system("ls -tl #{target}") if system(command)
        system("touch #{target}")
        mtime = File.mtime(target)
        break
      end
    end
  end
end
